<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Earth Waves 地球波动</title>
    <meta name="description" content="一个由现场录音爱好者亲手录制的网站，收录了地球上各种自然声音，从森林里的鸟鸣到深海的波涛。聆听、放松，感受我们星球的脉搏。 (A website curated by a field recording enthusiast, collecting various natural sounds on Earth, from birdsong in the forest to the waves of the deep sea. Listen, relax, and feel the pulse of our planet.)">
    <meta name="keywords" content="自然声音, 白噪音, 放松, 助眠, 录音, 地球, 海浪, 鸟鸣, natural sounds, white noise, relaxation, sleep aid, field recording, earth, ocean waves, bird song">
    <link rel="icon" href="icon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css">
    <style>
        :root {
            --player-height: 90px;
            --pico-primary-focus: var(--pico-primary-hover);
            --pico-font-size: 14px;
        }
        body {
            padding-bottom: var(--player-height);
        }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* 导航栏 Logo */
        nav ul { display: flex; align-items: center; gap: 0.75rem; margin: 0; }
        nav li { list-style-type: none; }

        /* 表格样式 */
        figure { margin: 0; overflow-x: auto; }
        th, td { padding: 8px 12px; vertical-align: middle; white-space: nowrap; }
        tr.is-playing { background-color: var(--pico-secondary-background); }
        .action-cell { text-align: center; }
        .action-cell a, .action-cell button {
            display: inline-flex;
            justify-content: center; align-items: center;
            padding: 4px; margin: 0;
            opacity: 0.7; color: var(--pico-h_color);
            transition: opacity 0.2s ease;
            background: none; border: none; cursor: pointer;
        }
        .action-cell a:hover, .action-cell button:hover { opacity: 1; color: var(--pico-primary); }
        .action-cell svg { width: 1.5em; height: 1.5em; }
        
        /* 播放/暂停图标切换 (CSS 方式) */
        .play-button .icon-pause, .play-button.is-playing .icon-play { display: none; }
        .play-button.is-playing .icon-pause, .play-button .icon-play { display: block; }
        #play-pause-button .icon-pause, #play-pause-button.is-playing .icon-play { display: none; }
        #play-pause-button.is-playing .icon-pause, #play-pause-button .icon-play { display: block; }

        /* 底部播放器样式 */
        .audio-player-container {
            position: fixed; bottom: 0; left: 0;
            width: 100%; height: var(--player-height);
            background-color: var(--pico-card-background-color);
            border-top: 1px solid var(--pico-form-element-border-color);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
            z-index: 1000; padding: 0 20px;
        }
        .audio-player-container .container {
            display: flex; align-items: center; justify-content: space-between;
            height: 100%; gap: 2rem;
        }
        .player-timeline { flex-grow: 1; display: flex; flex-direction: column; justify-content: center; min-width: 0;}
        .track-info { font-size: 0.9em; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .progress-bar-container { display: flex; align-items: center; gap: 10px; font-size: 0.8em; color: var(--pico-muted-color); }
        input[type="range"] { flex-grow: 1; height: 5px; margin: 0; }

        .player-controls { display: flex; align-items: center; gap: 0.5rem; }
        .player-controls button {
            width: 44px; height: 44px; border-radius: 50%; padding: 0;
            display: flex; justify-content: center; align-items: center;
            background-color: transparent; border: 2px solid transparent;
        }
        .player-controls button:hover { border-color: var(--pico-secondary-hover); }
        .player-controls button.main-play-pause { border-color: var(--pico-contrast-border-color); }
        .player-controls button.main-play-pause:hover { border-color: var(--pico-primary-hover); }
        .player-controls svg { width: 1.5em; height: 1.5em; }
        #main-audio-player { display: none; }

        /* Styles for the mode button wrapper to align with other controls */
        .player-controls .mode-button-wrapper {
            position: relative; /* Establish positioning context for absolute children */
            height: 44px; /* Give it the same height as other buttons */
            display: flex; /* Make it a flex container */
            align-items: center; /* Vertically align button inside */
            justify-content: center; /* Horizontally align button inside */
            /* The text will be positioned absolutely */
        }
        .player-controls .mode-button-wrapper #mode-text {
            position: absolute;
            bottom: -8px; /* Further reduced spacing for tighter combination */
            left: 50%;
            font-size: 10px; /* Set a fixed base font size */
            white-space: nowrap; /* Prevent text wrapping */
            transform-origin: center top; /* Scale from the top-center */
            transform: translateX(-50%) scale(0.8); /* Scale down for smaller appearance */
        }

        @media (max-width: 768px) {
            :root {
                --player-height: 120px;
            }
            .audio-player-container .container {
                flex-direction: column;
                justify-content: center;
                gap: 0.5rem;
                padding: 10px 0;
            }
            .player-timeline {
                width: 100%;
            }
            .player-controls {
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <nav>
            <ul>
                <li>
                    <img src="icon.svg" alt="Logo" style="width: 32px; height: 32px; display: block;">
                </li>
                <li><strong>Earth Waves 地球波动：录音样本</strong></li>
                <li><a href="./about.html">关于</a></li>
            </ul>
        </nav>
        <main>
            <figure>
                <table>
                    <thead>
                        <tr>
                            <th>播放</th>
                            <th>#</th>
                            <th>标题</th>
                            <th>时长</th>
                            <th>录音位置</th>
                            <th>录音时间</th>
                            <th>下载</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{ range $index, $element := . }}
                        <tr data-track-index="{{ $index }}">
                            <td class="action-cell">
                                <button class="play-button table-action-button" data-index="{{ $index }}" title="播放/暂停">
                                    <svg class="icon-play" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>
                                    <svg class="icon-pause" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
                                </button>
                            </td>
                            <td>{{ add $index 1 }}</td>
                            <td>{{ $element.Title }}</td>
                            <td>{{ formatDuration $element.DurationSeconds }}</td>
                            <td>{{ $element.Location }}</td>
                            <td>{{ $element.RecordDate.Format "2006-01-02 15:04" }}</td>
                            <td class="action-cell">
                                <a href="{{ $element.CompressedAudioPath }}" class="table-action-button" download title="下载 AAC ({{ printf "%.2fMB" $element.CompressedFileSizeMB }})">
                                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"></path></svg>
                                </a>
                            </td>
                        </tr>
                        {{ else }}
                        <tr>
                            <td colspan="10" style="text-align: center;">暂无录音样本可展示。</td>
                        </tr>
                        {{ end }}
                    </tbody>
                </table>
            </figure>
        </main>
    </div>

    <div class="audio-player-container">
        <div class="container">
            <div class="player-timeline">
                <div id="current-track-title" class="track-info">未选择录音</div>
                <div class="progress-bar-container">
                    <span id="current-time">00:00</span>
                    <input type="range" id="progress-bar" value="0" min="0" max="100" step="0.1">
                    <span id="total-duration">00:00</span>
                </div>
            </div>
            <div class="player-controls">
                <div class="mode-button-wrapper" style="text-align: center;">
                    <button id="mode-button" class="secondary outline" aria-label="播放模式">
                        <svg class="icon-list-play" title="列表播放" viewBox="0 0 24 24" fill="currentColor"><path d="M4 10h12v2H4zm0-4h12v2H4zm0 8h8v2H4zm10 0v6l5-3z"></path></svg>
                        <svg class="icon-list-loop" title="列表循环" viewBox="0 0 24 24" fill="currentColor" style="display: none;"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z"></path></svg>
                        <svg class="icon-single-loop" title="单曲循环" viewBox="0 0 24 24" fill="currentColor" style="display: none;"><path d="M7 7h10v3l4-4-4-4v3H5v6h2V7zm10 10H7v-3l-4 4 4 4v-3h12v-6h-2v4z M11.25 8h1.5v8h-1.5z"></path></svg>
                    </button>
                    <small id="mode-text" style="font-size: 0.7em; display: block; margin-top: 4px;"></small>
                </div>
                <button id="prev-button" class="secondary outline" aria-label="上一曲" disabled>
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 6h2v12H6zm3.5 6 8.5 6V6z"></path></svg>
                </button>
                <button id="play-pause-button" class="secondary outline main-play-pause" aria-label="播放/暂停" disabled>
                    <svg class="icon-play" viewBox="0 0 24 24" fill="currentColor"><path d="M8 5v14l11-7z"></path></svg>
                    <svg class="icon-pause" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>
                </button>
                <button id="next-button" class="secondary outline" aria-label="下一曲" disabled>
                    <svg viewBox="0 0 24 24" fill="currentColor"><path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"></path></svg>
                </button>
            </div>
            <audio id="main-audio-player" preload="auto"></audio>
        </div>
    </div>

    <script>
        // DOM Elements
        const audioPlayer = document.getElementById('main-audio-player');
        const playPauseBtn = document.getElementById('play-pause-button');
        const prevBtn = document.getElementById('prev-button');
        const nextBtn = document.getElementById('next-button');
        const trackTitle = document.getElementById('current-track-title');
        const playButtons = document.querySelectorAll('.play-button');
        const allRows = document.querySelectorAll('tbody tr');
        const progressBar = document.getElementById('progress-bar');
        const currentTimeEl = document.getElementById('current-time');
        const totalDurationEl = document.getElementById('total-duration');
        const modeBtn = document.getElementById('mode-button');
        const modeTextEl = document.getElementById('mode-text'); // Defined modeTextEl

        // Playback State
        let currentTrackIndex = -1;
        const modes = ['list-play', 'list-loop', 'single-loop'];
        const modeTexts = ['列表播放', '列表循环', '单曲循环']; // Defined modeTexts
        let currentModeIndex; // Declare currentModeIndex
        // Initialize currentModeIndex from localStorage or default
        const storedMode = localStorage.getItem('play-mode');
        if (storedMode !== null) { // Check if item exists in local storage
            const parsedMode = parseInt(storedMode, 10);
            if (!isNaN(parsedMode) && parsedMode >= 0 && parsedMode < modes.length) {
                currentModeIndex = parsedMode;
            } else {
                currentModeIndex = 2; // Default to single-loop if stored value is invalid
            }
        } else {
            currentModeIndex = 2; // Default to single-loop if nothing is stored
        }
        const tracks = [
            {{ range . }}
            { src: "{{ .CompressedAudioPath }}", title: "{{ .Title }}", duration: {{ .DurationSeconds }} },
            {{ end }}
        ];

        // Helper Functions
        function formatTime(seconds) {
            if (isNaN(seconds) || seconds < 0) return "00:00";
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            return `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}`;
        }
        
        function updatePlayerUI(playingIndex, isPlaying) {
            allRows.forEach((row, index) => {
                row.classList.toggle('is-playing', index === playingIndex);
                const rowBtn = row.querySelector('.play-button');
                if (rowBtn) {
                    const isThisTrackPlaying = (index === playingIndex && isPlaying);
                    rowBtn.querySelector('.icon-play').style.display = isThisTrackPlaying ? 'none' : 'block';
                    rowBtn.querySelector('.icon-pause').style.display = isThisTrackPlaying ? 'block' : 'none';
                }
            });
            const mainPlayIcon = playPauseBtn.querySelector('.icon-play');
            const mainPauseIcon = playPauseBtn.querySelector('.icon-pause');
            if (mainPlayIcon) mainPlayIcon.style.display = isPlaying ? 'none' : 'block';
            if (mainPauseIcon) mainPauseIcon.style.display = isPlaying ? 'block' : 'none';
        }
        
        // Helper function to update the UI for the current mode (icon and text)
        function updateModeUI() {
            const currentMode = modes[currentModeIndex];
            const icons = modeBtn.querySelectorAll('svg');
            icons.forEach(icon => icon.style.display = 'none');
            
            if (currentMode === 'list-play') {
                modeBtn.querySelector('.icon-list-play').style.display = 'block';
            } else if (currentMode === 'list-loop') {
                modeBtn.querySelector('.icon-list-loop').style.display = 'block';
            } else { // single-loop
                modeBtn.querySelector('.icon-single-loop').style.display = 'block';
            }
            modeTextEl.textContent = modeTexts[currentModeIndex]; // Update mode text
        }

        // Helper function to update the disabled state of playback controls
        function updatePlaybackControlsState() {
            const hasTracks = tracks.length > 0;
            const isLoopingList = modes[currentModeIndex] === 'list-loop';
            
            playPauseBtn.disabled = !hasTracks;
            modeBtn.disabled = !hasTracks;

            if (hasTracks) {
                prevBtn.disabled = (currentTrackIndex <= 0 && !isLoopingList);
                nextBtn.disabled = (currentTrackIndex >= tracks.length - 1 && !isLoopingList);
            } else {
                prevBtn.disabled = true;
                nextBtn.disabled = true;
            }
        }
        
        // Core Player Logic
        function playTrack(index) {
            const isEndOfList = index >= tracks.length;
            const isStartOfList = index < 0;

            if (isEndOfList) {
                if (modes[currentModeIndex] === 'list-loop') {
                    index = 0;
                } else {
                    audioPlayer.pause();
                    currentTrackIndex = -1;
                    trackTitle.textContent = "播放列表已结束";
                    updatePlayerUI(-1, false);
                    return;
                }
            }
            if (isStartOfList) {
                if(modes[currentModeIndex] === 'list-loop') {
                    index = tracks.length - 1;
                } else {
                    return;
                }
            }

            currentTrackIndex = index;
            const track = tracks[currentTrackIndex];
            audioPlayer.src = track.src;
            trackTitle.textContent = track.title;
            totalDurationEl.textContent = formatTime(track.duration);
            audioPlayer.play();
            updatePlaybackControlsState(); // Update controls after track change
        }

        // Event Listeners
        playButtons.forEach((button) => {
            button.addEventListener('click', (e) => {
                e.preventDefault();
                const index = parseInt(button.dataset.index, 10);
                if (currentTrackIndex === index && !audioPlayer.paused) {
                    audioPlayer.pause();
                } else {
                    playTrack(index);
                }
            });
        });

        playPauseBtn.addEventListener('click', () => {
            if (currentTrackIndex === -1 && tracks.length > 0) {
                 playTrack(0);
                 return;
            }
            if (audioPlayer.paused) audioPlayer.play();
            else audioPlayer.pause();
        });
        
        prevBtn.addEventListener('click', () => playTrack(currentTrackIndex - 1));
        nextBtn.addEventListener('click', () => playTrack(currentTrackIndex + 1));

        audioPlayer.addEventListener('play', () => {
            updatePlaybackControlsState();
            updatePlayerUI(currentTrackIndex, true);
        });

        audioPlayer.addEventListener('pause', () => {
            updatePlaybackControlsState();
            updatePlayerUI(currentTrackIndex, false);
        });

        audioPlayer.addEventListener('ended', () => {
            const currentMode = modes[currentModeIndex];
            if (currentMode === 'single-loop') {
                playTrack(currentTrackIndex);
            } else {
                playTrack(currentTrackIndex + 1);
            }
        });
        
        audioPlayer.addEventListener('timeupdate', () => {
            if (!isNaN(audioPlayer.duration) && audioPlayer.duration > 0) {
                progressBar.value = (audioPlayer.currentTime / audioPlayer.duration) * 100 || 0;
                currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
            }
        });

        progressBar.addEventListener('input', () => {
            if (!isNaN(audioPlayer.duration) && audioPlayer.duration > 0) {
                audioPlayer.currentTime = (progressBar.value / 100) * audioPlayer.duration;
            }
        });

        modeBtn.addEventListener('click', () => {
            currentModeIndex = (currentModeIndex + 1) % modes.length;
            localStorage.setItem('play-mode', currentModeIndex);
            updateModeUI(); // Update mode icon and text
            updatePlaybackControlsState(); // Update prev/next button states
            modeBtn.blur();
        });

        // Initial setup on page load
        updatePlaybackControlsState();
        updatePlayerUI(-1, false); // Initialize UI with no track playing
        updateModeUI();

        // Global spacebar for play/pause
        document.addEventListener('keydown', (event) => {
            if (event.code === 'Space' || event.key === ' ') {
                const targetTagName = event.target.tagName.toLowerCase();
                if (targetTagName === 'input' || targetTagName === 'textarea') {
                    return;
                }
                event.preventDefault();
                playPauseBtn.click();
            }
        });
    </script>
</body>
</html>
